// Generated by CoffeeScript 1.3.1

window.InputView = Backbone.View.extend({
  events: {
    "click .back": "back",
    "submit": "submit",
    "change #input": "onInputChanged",
    "click #favicon": "onFavIconClick",
    "click .favitem": "onFavItemClick"
  },
  initialize: function() {
    this.template = _.template(tpl.get('input'));
    this.favorites = new Favorites();
    this.favorites.bind('add', this.addOne, this);
    this.favorites.bind('remove', this.removeOne, this);
    return this.favorites.bind('reset', this.addAll, this);
  },
  render: function() {
    var inputValue;
    this.target = getUrlParam("target");
    inputValue = window.InputView.prototype[this.target];
    $(this.el).html(this.template({
      currentInput: inputValue
    }));
    this.favlist = $(this.el).find("#favlist");
    this.onInputChanged(null);
    return this;
  },
  updateListview: function() {
    this.favorites.fetch();
    return this.onInputChanged();
  },
  submit: function(event) {
    event.preventDefault();
    window.InputView.prototype[this.target] = $(this.el).find("#input")[0].value;
    app.navigate("/", true);
  },
  addOne: function(item) {
    var address;
    address = item.get("address");
    if (address !== void 0 && address !== "") {
      item = new FavoriteItemView({
        model: item
      }).render().el;
      this.favlist.append(item);
      this.refreshListView();
    }
  },
  addAll: function() {
    var _this = this;
    this.favlist.empty();
    _.each(this.favorites.models, function(item, index) {
      return _this.addOne(item);
    });
  },
  removeOne: function(item) {
    this.favlist.empty();
    return this.addAll();
  },
  onInputChanged: function(event) {
    var favIcon, inputValue, matches;
    window.InputView.prototype[this.target] = $(this.el).find("#input")[0].value;
    inputValue = $(this.el).find("#input")[0].value;
    favIcon = $(this.el).find("#favicon")[0];
    matches = this.favorites.byAddress(inputValue);
    if (matches.length > 0) {
      return favIcon.src = favIcon.src.replace("off", "on");
    } else {
      return favIcon.src = favIcon.src.replace("on", "off");
    }
  },
  onFavIconClick: function(event) {
    var address, el, enabled, fav;
    el = $(this.el).find("#favicon")[0];
    enabled = el.src.indexOf("off") !== -1;
    if (enabled) {
      el.src = el.src.replace("off", "on");
    } else {
      el.src = el.src.replace("on", "off");
    }
    address = $("#input")[0].value;
    if (enabled) {
      if (!this.favorites.contains({
        address: address
      })) {
        fav = this.favorites.create({
          address: address
        });
      }
    } else {
      _.each(this.favorites.byAddress(address), function(fav) {
        return fav.destroy();
      });
    }
  },
  onFavItemClick: function(event) {
    return $(this.el).find("#input")[0].value = event.currentTarget.innerHTML;
  },
  refreshListView: function() {
    try {
      return this.favlist.listview("refresh");
    } catch (error) {
      return console.debug(error);
    }
  }
});

window.FavoriteItemView = Backbone.View.extend({
  tagname: "li",
  initialize: function() {
    return this.template = _.template(tpl.get('favorite-item'));
  },
  render: function() {
    $(this.el).html(this.template({
      address: this.model.get("address"),
      index: this.options.index
    }));
    return this;
  }
});
